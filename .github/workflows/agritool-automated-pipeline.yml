name: AgriTool Automated Pipeline

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to use (Use workflow from)'
        required: true
        default: 'main'
        type: string
      
      max_pages:
        description: 'Maximum pages to scrape (0 = unlimited)'
        required: true
        default: '0'
        type: string
      
      dry_run:
        description: 'Dry run mode (no database writes)'
        required: true
        default: false
        type: boolean
      
      run_tests:
        description: 'Run comprehensive test suite'
        required: true
        default: true
        type: boolean
      
      batch_size:
        description: 'AI agent batch size'
        required: true
        default: '10'
        type: string
      
      # NEW INPUT - Number of URLs to scrape per run
      urls_to_scrape:
        description: 'Number of URLs to scrape in this run (e.g., 10, 25, 100)'
        required: true
        default: '25'
        type: string

jobs:
  agritool-pipeline:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests tika ocrmypdf ghostscript
        # Install additional dependencies as needed
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ghostscript tesseract-ocr ocrmypdf openjdk-17-jre-headless
    
    - name: Start Apache Tika Server
      run: |
        echo "🚀 Starting Apache Tika Server..."
        cd AgriTool-Raw-Log-Interpreter
        python tika_server_manager.py start
        if [ $? -ne 0 ]; then
          echo "❌ Failed to start Tika server"
          exit 1
        fi
    
    - name: Wait for Tika Server Ready
      run: |
        echo "⏳ Waiting for Tika server to be ready..."
        for i in {1..30}; do
          if curl -s --connect-timeout 5 http://localhost:9998/tika/version; then
            echo "✅ Tika server is ready"
            break
          else
            echo "⏳ Attempt $i/30: Tika server not ready, waiting 5 seconds..."
            sleep 5
          fi
          if [ $i -eq 30 ]; then
            echo "❌ Tika server failed to start after 150 seconds"
            exit 1
          fi
        done
    
    - name: Run Comprehensive Test Suite
      if: ${{ github.event.inputs.run_tests == 'true' }}
      run: |
        echo "🧪 Running comprehensive test suite..."
        # Add your test commands here
        python -m pytest tests/ -v || echo "Tests completed with warnings"
    
    - name: Run AgriTool Pipeline
      env:
        MAX_PAGES: ${{ github.event.inputs.max_pages }}
        DRY_RUN: ${{ github.event.inputs.dry_run }}
        BATCH_SIZE: ${{ github.event.inputs.batch_size }}
        URLS_TO_SCRAPE: ${{ github.event.inputs.urls_to_scrape }}
      run: |
        echo "🌱 Starting AgriTool Pipeline with parameters:"
        echo "  - Branch: ${{ github.event.inputs.branch }}"
        echo "  - Max pages per URL: $MAX_PAGES"
        echo "  - URLs to scrape: $URLS_TO_SCRAPE"
        echo "  - Batch size: $BATCH_SIZE"
        echo "  - Dry run: $DRY_RUN"
        echo "  - Run tests: ${{ github.event.inputs.run_tests }}"
        
        # Navigate to the appropriate directory
        cd AgriTool-Raw-Log-Interpreter
        
        # Build the command with all parameters (with Tika pipeline)
        PIPELINE_CMD="python enhanced_agent.py"
        
        if [ "$MAX_PAGES" != "0" ]; then
          PIPELINE_CMD="$PIPELINE_CMD --max-pages $MAX_PAGES"
        fi
        
        if [ "$DRY_RUN" = "true" ]; then
          PIPELINE_CMD="$PIPELINE_CMD --dry-run"
        fi
        
        if [ "${{ github.event.inputs.run_tests }}" = "true" ]; then
          PIPELINE_CMD="$PIPELINE_CMD --run-tests"
        fi
        
        PIPELINE_CMD="$PIPELINE_CMD --batch-size $BATCH_SIZE"
        PIPELINE_CMD="$PIPELINE_CMD --urls-to-scrape $URLS_TO_SCRAPE"
        
        echo "🚀 Executing: $PIPELINE_CMD"
        eval $PIPELINE_CMD
    
    - name: Stop Tika Server
      if: always()
      run: |
        echo "🛑 Stopping Apache Tika Server..."
        cd AgriTool-Raw-Log-Interpreter
        python tika_server_manager.py stop || echo "Tika server was not running"
    
    - name: Upload Pipeline Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: agritool-pipeline-logs-${{ github.run_number }}
        path: |
          AgriTool-Raw-Log-Interpreter/*.log
          AgriTool-Raw-Log-Interpreter/logs/
        retention-days: 7
    
    - name: Pipeline Summary
      if: always()
      run: |
        echo "## 🌱 AgriTool Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URLs Scraped**: ${{ github.event.inputs.urls_to_scrape }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Max Pages per URL**: ${{ github.event.inputs.max_pages }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Batch Size**: ${{ github.event.inputs.batch_size }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Dry Run Mode**: ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests Run**: ${{ github.event.inputs.run_tests }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow Run**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY